# 隔離されたコア

## 前の節の導入

汎用サブドメインを括り出すことで雑音が減り、凝集されたメカニズムによって複雑な操作がカプセル化される。
後に残るのは、より焦点の絞られたモデルであり、ユーザの活動に何ら価値を加えることのない、注意を散漫にする要因は減る。
しかし、コアでないものすべてについて、ドメインモデルの中に落ち着く場所が見つかるわけでもない。

次に取り上げる**隔離されたコア**は、コアドメインを構造的に区切る直接的なアプローチを取る

## 背景

貧弱な設計が作られる理由は、

設計者が最も重要な関係性を明確に理解することができていないためである。

それは雑音ともつれにより、コアの発達が妨げられている状態が原因

雑音ともつれとは

+ コアの概念上の凝集が、強くもなく可視的でもない
+ コアに仕える要素が、汎用的な要素と密接に結合している
+ モデル内にある複数の要素が、一部がコアドメインに仕え、一部が補助的な役割を果たしている

という状態である。

前節で、対策方法として汎用サブドメインを使うという話があった。

しかし、

+ サブドメインを全て識別し、明確化するのは困難
+ 中にはそこまでする価値がないものもある

などの理由で、汎用サブドメインの抽出だけでは不十分で、最も重要なコアドメインは残留物と絡まったまま放置されてしまうかもしれない。


## 主張

モデルをリファクタリングして、コアの概念を補助的な役割を果たすものから分離するべし。
これはモデルをリファクタリングした結果、密接に結合している要素を分離することになるとしても、やらなければならない

#### どうやって？

+ コアの凝集度を高める
+ 他のコードへの結合を低くする
+ 汎用的な要素や補助的な要素は全て別のオブジェクトに括りだし、それを別のパッケージに入れる

#### 汎用サブドメインとの違い

+ 汎用サブドメインに適用したのと基本的には同じ原則だが、**方向性が異なる**
+ アプリケーションの中心である凝集されたサブドメイン(コアドメイン)は、識別して一貫性のあるパッケージに分割でき、後に残るどこにも入らない塊をどうするかは、どうでも良いというわけではないが、重要でもない。
+ 残留物の取り扱い方法
  + 汎用サブドメインに括り出せるかもしれない
  + 元の場所に残しても良い
  + 主要なクラスに基づいてどこかのパッケージに入れても良い
  + -> 大切なのは、隔離されたコアへの集中を保つこと

## 隔離されたコアを抽出するための具体的なステップ

1. コアサブドメインを識別する
  + 蒸留ドキュメントから引き出すこともできる
2. 関連するクラスを、それを関連づけている概念に由来する新しいモジュールへ移動する
3. コードをリファクタリングして、その概念を直接表現していないデータと機能を切り離す
  + 取り除いた側面は他のパッケージにあるクラスに入れる
  + 概念的に関連するタスクト一緒にすべきだが、完璧を記すことにあまり時間を浪費してはならない
  + コアサブドメンから不純物を除去して綺麗にし、他のパッケージへの参照を、明示的で意図の表現されたものにするよう専念する
4. 新しい隔離されたコアのモジュールをリファクタリングして、関係と相互作用をより単純で伝達力のあるものにし、他のモジュールとの関係を最小限に抑えて明確化する
  + これは継続するリファクタリングの目標になる
5. 隔離されたコアが完成するまで、別のコアサブドメインに対して前述のステップを繰り返す

## 隔離されたコアを作成するコスト

#### デメリット

+ コアを隔離すると、コアと密接に結合した、コアでないクラス群との関係が、さらに曖昧で複雑になることがある
+ うまく凝集されていたモジュールが分割されることもある
  + この凝集を犠牲にする代わりにコアドメインの凝集度を高められる
+ コアを隔離するのは大変な作業になる
+ 隔離されたコアへ向かうと決定することで、システム全体に加えられる変更に開発者たちを取られてしまう可能性がある

#### メリット

+ コアドメインが明確になり作業をしやすくなる
+ コアドメイン内での凝集度を高められる

#### 隔離されたコアを切り出すべきタイミング

システムにとって重要な、巨大な境界づけられたコンテキストがあり、モデルの本質的な部分が大量の補助的な機能のせいで分かりにくくなってきた時

## チームの意思決定を進化させる

チーム全体が隔離されたコアに向かって一丸となって進まなければならない

#### これを達成するためにチームに求められること

+ チームの意思決定のプロセスと、決められたことを実行できるだけの規律と協調性があること

#### 課題

+ コアに対して同じ定義を用いることを全員に強制しながら、その決定を凍結させないようにすること -> 決定を柔軟に変える必要があるということだと思われる

#### コミュニケーションの重要性について

+ 隔離されたコアを作る作業は、何が本質的で何が補助的な要素かについての新しい洞察に繋がる
+ 得られた洞察は、モジュールに対する定義を改良するためにフィードバックする必要がある
  + 新しい洞察は、チームで継続的に共有する必要があるものの、個人がそれに基づいて一方的に行動することはできない
+ それ故、進むべき道を繰り返し修正できるくらいに共同での意思決定は俊敏でなければならない
+ コアに対しては全員が同じ見方をするくらいコミュニケーションは効果的でなければならない

## 15.4 貨物輸送モデルのコアを隔離する


